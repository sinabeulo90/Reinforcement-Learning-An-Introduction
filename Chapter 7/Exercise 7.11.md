## Exercise 7.11

### Question:

근사적 행동 가치가 변하지 않는다면, 트리 보강 이득(식 7.16)이 다음과 같이 기댓값에 기반한 TD 오차의 합으로 표현될 수 있음을 보여라.

![equation](https://latex.codecogs.com/svg.latex?G_{t:t&plus;n}&space;=&space;Q(S_t,&space;A_t)&space;&plus;&space;\sum_{k=t}^{min(t&plus;n-1,&space;T-1)}&space;\delta_k&space;\prod_{i=t&plus;1}^k&space;\gamma&space;\pi(A_i&space;|&space;S_i))

여기서 ![equation](https://latex.codecogs.com/svg.latex?\delta_t&space;\doteq&space;R_{t&plus;1}&space;&plus;&space;\gamma&space;\bar{V}_t(S_{t&plus;1})&space;-&space;Q(S_t,&space;A_t)) 이고, ![equation](https://latex.codecogs.com/svg.latex?\bar{V}_t) 는 식 7.8로부터 주어진다.

### Answer:

<img src="https://latex.codecogs.com/svg.latex?\begin{align*}&space;G_{t:t&plus;n}&space;&\doteq&space;R_{t&plus;1}&space;&plus;&space;\gamma&space;\sum_{a&space;\neq&space;A_{t&plus;1}}&space;\pi(a|S_{t&plus;1})Q(S_{t&plus;1},&space;a)&space;&plus;&space;\gamma\pi(A_{t&plus;1}|S_{t&plus;1})G_{t&plus;1:t&plus;n}&space;\\&space;&=&space;R_{t&plus;1}&space;&plus;&space;\gamma&space;\sum_a&space;\pi(a|S_{t&plus;1})Q(S_{t&plus;1},&space;a)&space;-&space;Q(S_t,&space;A_t)&space;&plus;&space;Q(S_t,&space;A_t)&space;-&space;\gamma&space;\pi(A_{t&plus;1}|S_{t&plus;1})Q(S_{t&plus;1},&space;A_{t&plus;1})&space;&plus;&space;\gamma\pi(A_{t&plus;1}|S_{t&plus;1})G_{t&plus;1:t&plus;n}&space;\\&space;&=&space;Q(S_t,&space;A_t)&space;&plus;&space;\delta_t&space;&plus;&space;\gamma&space;\pi(A_{t&plus;1}|S_{t&plus;1})[G_{t&plus;1:t&plus;n}&space;-&space;Q(S_{t&plus;1},&space;A_{t&plus;1})]&space;\\&space;&=&space;Q(S_t,&space;A_t)&space;&plus;&space;\delta_t&space;&plus;&space;\delta_{t&plus;1}&space;\gamma&space;\pi(A_{t&plus;1}|S_{t&plus;1})&space;&plus;&space;\gamma^2&space;\pi(A_{t&plus;1}|S_{t&plus;1})&space;\pi(A_{t&plus;2}|S_{t&plus;2})[G_{t&plus;2:t&plus;n}&space;-&space;Q(S_{t&plus;2},&space;A_{t&plus;2})]&space;\\&space;&=&space;Q(S_t,&space;A_t)&space;&plus;&space;\delta_t&space;&plus;&space;\delta_{t&plus;1}&space;\gamma&space;\pi(A_{t&plus;1}|S_{t&plus;1})&space;&plus;&space;\cdots&space;&plus;&space;\delta_{\min(t&plus;n-1,&space;T-1)}&space;\prod_{i=t&plus;1}^{\min(t&plus;n-1,&space;T-1)}&space;\gamma&space;\pi(A_i|S_i)&space;\\&space;&\&space;\&space;\&space;&plus;&space;(G_{\min(t&plus;n,&space;T):t&plus;n}&space;-&space;Q(S_{\min(t&plus;n,&space;T)},&space;A_{\min(t&plus;n,&space;T)}))&space;\prod_{i=t&plus;1}^{\min(t&plus;n,&space;T)}&space;\gamma&space;\pi(A_i|S_i)&space;\\&space;&=&space;Q(S_t,&space;A_t)&space;&plus;&space;\sum_{k=t}^{\min(t&plus;n-1,&space;T-1)}&space;\delta_t&space;\prod_{i=t&plus;1}^{k}&space;\gamma&space;\pi(A_i|S_i)&space;\end{align*}" title="\begin{align*} G_{t:t+n} &\doteq R_{t+1} + \gamma \sum_{a \neq A_{t+1}} \pi(a|S_{t+1})Q(S_{t+1}, a) + \gamma\pi(A_{t+1}|S_{t+1})G_{t+1:t+n} \\ &= R_{t+1} + \gamma \sum_a \pi(a|S_{t+1})Q(S_{t+1}, a) - Q(S_t, A_t) + Q(S_t, A_t) - \gamma \pi(A_{t+1}|S_{t+1})Q(S_{t+1}, A_{t+1}) + \gamma\pi(A_{t+1}|S_{t+1})G_{t+1:t+n} \\ &= Q(S_t, A_t) + \delta_t + \gamma \pi(A_{t+1}|S_{t+1})[G_{t+1:t+n} - Q(S_{t+1}, A_{t+1})] \\ &= Q(S_t, A_t) + \delta_t + \delta_{t+1} \gamma \pi(A_{t+1}|S_{t+1}) + \gamma^2 \pi(A_{t+1}|S_{t+1}) \pi(A_{t+2}|S_{t+2})[G_{t+2:t+n} - Q(S_{t+2}, A_{t+2})] \\ &= Q(S_t, A_t) + \delta_t + \delta_{t+1} \gamma \pi(A_{t+1}|S_{t+1}) + \cdots + \delta_{\min(t+n-1, T-1)} \prod_{i=t+1}^{\min(t+n-1, T-1)} \gamma \pi(A_i|S_i) \\ &\ \ \ + (G_{\min(t+n, T):t+n} - Q(S_{\min(t+n, T)}, A_{\min(t+n, T)})) \prod_{i=t+1}^{\min(t+n, T)} \gamma \pi(A_i|S_i) \\ &= Q(S_t, A_t) + \sum_{k=t}^{\min(t+n-1, T-1)} \delta_t \prod_{i=t+1}^{k} \gamma \pi(A_i|S_i) \end{align*}" />
